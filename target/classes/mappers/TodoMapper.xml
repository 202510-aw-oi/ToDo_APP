<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.todo.mapper.TodoMapper">
    <select id="selectByFilters" resultType="com.example.todo.entity.Todo">
        SELECT
            id,
            author,
            title,
            detail,
            description,
            type,
            priority,
            created_at,
            updated_at,
            due_date,
            attachment_url
        FROM todos
        <trim prefix="WHERE" prefixOverrides="AND |OR ">
            <if test="type != null and type != ''">
                AND type = #{type}
            </if>
            <if test="priority != null">
                AND priority = #{priority}
            </if>
        </trim>
        <choose>
            <when test="sort == 'due_asc'">
                ORDER BY
                    due_date IS NULL,
                    due_date ASC,
                    created_at DESC
            </when>
            <when test="sort == 'due_desc'">
                ORDER BY
                    due_date IS NULL,
                    due_date DESC,
                    created_at DESC
            </when>
            <otherwise>
                ORDER BY created_at DESC
            </otherwise>
        </choose>
    </select>

    <select id="countByFilters" resultType="long">
        SELECT COUNT(*)
        FROM todos
        <trim prefix="WHERE" prefixOverrides="AND |OR ">
            <if test="type != null and type != ''">
                AND type = #{type}
            </if>
            <if test="priority != null">
                AND priority = #{priority}
            </if>
        </trim>
    </select>
</mapper>
